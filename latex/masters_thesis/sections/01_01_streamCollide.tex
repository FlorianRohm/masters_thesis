% !TEX root = ../thesis.tex
After stating the advantages of using~\eqref{eq: Boltzmann transport equation} for our entry point to fluid simulation, we will develop a discrete scheme out of it in this section.
This thesis will focus on the two dimensional case, as it is already shown to work in 3D by Geier et al.\ in~\cite{geier2015cumulant} and the 2D case is easier to grasp for an introduction. Nevertheless, justification of this 2D model is controversial as discussed in Section~\ref{sec: Outlook}.

First of all, we restrict ourselves to a computational domain being composed of square\footnote{There are researches for rectangular cells like~\cite{Bouzidi2001704}, but to the authors knowledge it's rarely used in any application.} cells with a constant width $c$.
Not too much attention should be granted to this value, as in most realizations, $c=1$ is chosen and this factor will vanish.
Nevertheless, we will maintain $c$ as a variable through most of the calculations and explicitly state when it's set to one.

The next step for the discretization is to restrict our velocity space to a finite set of velocities. As we will see in a bit, we want the cell spacing and the velocities to coincide, so we choose our microscopic velocities to be
\begin{equation}
  \label{eq: definition of the velocities}
  \vec{c}_{ij} \defined c\begin{pmatrix}i \\ j\end{pmatrix}, \quad\forall i,j\in \{-1, 0, 1\}.
\end{equation}
Hence, our particle distribution function $f(\vec{v},\vec{x},t)$ can now be interpreted as nine functions $f_{ij}(\vec{x},t)$, one for each direction.
Being in two dimensions, we also split the vector $\vec{x}$ into its components $x$ and $y$, leaving us with $f_{ij}(x,y,t)$ for the velocity-discretized particle distributions.

In LBM jargon, the choice of velocities is called the stencil, which is denoted by D$n$Q$m$, with $n$ being the dimension and $m$ the cardinality of the velocity set.
Consequently, we're working with a D2Q9 model, which is depicted in Figure~\ref{fig: D2Q9 stencil}.

\begin{figure}
  \centering
  \begin{tikzpicture}

    \draw (-3,-3) rectangle (3,3);
    \pdf{black}{0,3}
    \pdf{black}{3,0}
    \pdf{black}{0,-3}
    \pdf{black}{-3,0}

    \pdf{black}{3,-3}
    \pdf{black}{-3,3}
    \pdf{black}{-3,-3}
    \pdf{black}{3,3}
    \fill (0,0) circle (3pt);

    \node at (3.5,0) {$f_{1,0}$};
    \node at (0,3.3) {$f_{0,1}$};
    \node at (0,-3.3) {$f_{0,\text{-}1}$};
    \node at (-3.5,0) {$f_{0,\text{-}1}$};

    \node at (3.5,3.3) {$f_{1,1}$};
    \node at (-3.5,3.3) {$f_{\text{-}1,1}$};
    \node at (3.5,-3.3) {$f_{1,\text{-}1}$};
    \node at (-3.5,-3.3) {$f_{\text{-}1,\text{-}1}$};

    \node at (0.6,0.2)  {$f_{0,0}$};
  \end{tikzpicture}
\caption{The D$2$Q$9$ stencil. The indices in this picture are separated to be better distinguishable.}
\label{fig: D2Q9 stencil}
\end{figure}

The simplest way for discretizing the derivatives is to use a combination of implicit and explicit Euler terms, where we set the relation between the size of the timesteps $\Delta t$ and spacial stepsizes $\Delta x$ and $\Delta y$ to
\begin{equation}
  \label{eq: relation between stepsizes}
  \frac{\Delta x} {\Delta{t}} = \frac{\Delta y} {\Delta{t}} = c
\end{equation}
As motivated in Section~\ref{sec: History of Lattice Boltzmann}, we will use another collision operator $\tilde{\Omega}$, modeling the effect of the collisions in one timestep, instead of the original $\Omega$.
This will be further specified in Section~\ref{sub: Relaxation rates and their issues}.
Using the described techniques, equation~\eqref{eq: Boltzmann transport equation} can be transformed to
\begin{equation}
  \label{eq: lattice boltzmann equation}
  \begin{aligned}
    f_{ij}(x + i \Delta x , y + j \Delta y,t + \Delta t)
    &= \tilde{\Omega}(f_{ij}(x,y,t))
    + f_{ij}(x,y,t)
    \\&
    \defines f_{ij}^*(x, y, t),
  \end{aligned}
\end{equation}
for all $i,j\in \{-1, 0, 1\}$, where $f_{ij}$ are the pre-collision distributions and $f_{ij}^*$ the post-collision distributions.
The full derivation of~\eqref{eq: lattice boltzmann equation} can be found in Appendix~\ref{appendix: Lattice Boltzmann Equation}.

Now, we can finally introduce the most known keywords associated to LBM:\@ stream and collide.
When looking at~\eqref{eq: lattice boltzmann equation}, we see, that we need two substeps for each iteration of the equation.

Number one is the calculation of the post-collision distributions in each cell and can be found on the right hand side of~\eqref{eq: lattice boltzmann equation}. This is known as the collide step, illustrated in Figure~\ref{fig: examplary collision}.

\begin{figure}
\centering
\begin{subfigure}{.5\textwidth}
  \centering

  \begin{tikzpicture}

  \draw (-3,-3) rectangle (3,3);
  \pdf{black}{0,2};
  \pdf{black}{0.7,0};
  \pdf{black}{0,-1.5};
  \pdf{black}{-1.2,0};

  \pdf{black}{0.8,-0.8};
  \pdf{black}{-1.2,1.2};
  \pdf{black}{-1.2,-1.2};
  \pdf{black}{1,1};
  \fill (0,0) circle (3pt);
  \end{tikzpicture}
\caption{Exemplaric pre-collision \glspl{pdf} $f_{ij}$\linebreak}
\label{fig: pre-collision example}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \begin{tikzpicture}

  \draw (-3,-3) rectangle (3,3);

  \pdf{gray}{0,2};
  \pdf{gray}{0.7,0};
  \pdf{gray}{0,-1.5};
  \pdf{gray}{-1.2,0};

  \pdf{gray}{0.8,-0.8};
  \pdf{gray}{-1.2,1.2};
  \pdf{gray}{-1.2,-1.2};
  \pdf{gray}{1,1};

  \fill (0,0) circle (3pt);

  \pdf{black}{0,1.8};
  \pdf{black}{0.9,0};
  \pdf{black}{0,-1.2};
  \pdf{black}{-1.15,0};

  \pdf{black}{0.85,-0.85};
  \pdf{black}{-1.26,1.26};
  \pdf{black}{-1.1,-1.1};
  \pdf{black}{0.9,0.9};

  \end{tikzpicture}
\caption{Exemplaric post-collision \glspl{pdf} $f_{ij}^*$, pre-collision ones are shadowed in gray.}
\label{fig: post-collision example}
\end{subfigure}
\caption{Collision in the \gls{lbm}. The distributions are rearranged according to the collision rule.}
\label{fig: examplary collision}
\end{figure}

Number two is found on the left hand side and formulates the spreading of the distributions according to their velocities to form the new particle distributions for the timestep $t+\Delta t$.
Unsurprisingly, this is called the streaming step, as it moves the particle distributions to new nodes.

\begin{figure}
\centering
\begin{subfigure}{.5\textwidth}
  \centering

  \begin{tikzpicture}[scale=0.35, every node/.style={scale=0.35}]

% grid
  \draw (3,3) rectangle (9,9);
  \draw (3,-3) rectangle (9,3);
  \draw (3,-9) rectangle (9,-3);

  \draw (-3,3) rectangle (3,9);
  \draw (-3,-3) rectangle (3,3);
  \draw (-3,-9) rectangle (3,-3);

  \draw (-9,3) rectangle (-3,9);
  \draw (-9,-3) rectangle (-3,3);
  \draw (-9,-9) rectangle (-3,-3);

  \pdfSmallCenter{black}{0,0}{0,2};
  \pdfSmallCenter{black}{0,0}{0.7,0};
  \pdfSmallCenter{black}{0,0}{0,-1.5};
  \pdfSmallCenter{black}{0,0}{-1.2,0};

  \pdfSmallCenter{black}{0,0}{0.8,-0.8};
  \pdfSmallCenter{black}{0,0}{-1.2,1.2};
  \pdfSmallCenter{black}{0,0}{-1.2,-1.2};
  \pdfSmallCenter{black}{0,0}{1,1};


  \pdfSmallCenter{red}{0, -6}{0,1.5};
  \pdfSmallCenter{red}{0,6}{0,-2};

  \pdfSmallCenter{red}{-6,6}{1,-1};
  \pdfSmallCenter{red}{-6, 0}{1.7,0};
  \pdfSmallCenter{red}{-6,-6}{0.8,0.8};

  \pdfSmallCenter{red}{6, 6}{-1.8,-1.8};
  \pdfSmallCenter{red}{6,0}{-0.5,0};
  \pdfSmallCenter{red}{6, -6}{-0.8,0.8};

  \fill (0,0) circle (3pt);
  \end{tikzpicture}
\caption{Exemplaric pre-stream \glspl{pdf} setting for the \glspl{pdf}.}
\label{fig: pre-stream example}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering

    \begin{tikzpicture}[scale=0.35, every node/.style={scale=0.35}]

  % grid
    \draw (3,3) rectangle (9,9);
    \draw (3,-3) rectangle (9,3);
    \draw (3,-9) rectangle (9,-3);

    \draw (-3,3) rectangle (3,9);
    \draw (-3,-3) rectangle (3,3);
    \draw (-3,-9) rectangle (3,-3);

    \draw (-9,3) rectangle (-3,9);
    \draw (-9,-3) rectangle (-3,3);
    \draw (-9,-9) rectangle (-3,-3);


    \pdfSmallCenter{black}{0,6}{0,2};
    \pdfSmallCenter{black}{6,0}{0.7,0};
    \pdfSmallCenter{black}{0,-6}{0,-1.5};
    \pdfSmallCenter{black}{-6,0}{-1.2,0};

    \pdfSmallCenter{black}{6,-6}{0.8,-0.8};
    \pdfSmallCenter{black}{-6,6}{-1.2,1.2};
    \pdfSmallCenter{black}{-6,-6}{-1.2,-1.2};
    \pdfSmallCenter{black}{6,6}{1,1};


    \pdfSmallCenter{red}{0,0}{0,1.5};
    \pdfSmallCenter{red}{0,0}{0,-2};

    \pdfSmallCenter{red}{0,0}{1,-1};
    \pdfSmallCenter{red}{0,0}{1.7,0};
    \pdfSmallCenter{red}{0,0}{0.8,0.8};

    \pdfSmallCenter{red}{0,0}{-1.8,-1.8};
    \pdfSmallCenter{red}{0,0}{-0.5,0};
    \pdfSmallCenter{red}{0,0}{-0.8,0.8};

    \fill (0,0) circle (3pt);
    \end{tikzpicture}
    \caption{Exemplaric post-stream \glspl{pdf}.\linebreak}
\label{fig: post-collision example}
\end{subfigure}
\caption{Streaming in the \gls{lbm}. The distributions are shifted in the direction of their associated velocity. Every cell has of course all its nine \glspl{pdf}, but the ones not relevant to the center cell are left out}
\label{fig: examplary stream}
\end{figure}

Figure~\ref{fig: examplary stream} illustrates why we chose our velocities,~\eqref{eq: definition of the velocities}, and stepsizes,~\eqref{eq: relation between stepsizes}, in this particular way.
This allows us to move our distribution functions exactly to the next node in the direction they are pointing. Hence we don't need to interpolate those functions to get the new distribution functions at the nodes for the next timestep.

Now, we can imagine, why LBM is so good for parallel computation.
The streaming step, which needs access to neighboring nodes and therefore potentially to the memory of other cores, is completely linear.
The collide step, which we didn't specify in more detail, yet, will be more computationally heavy but completely local and thus can be computed in parallel.
